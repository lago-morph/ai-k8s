# ADR-004: kubectl and AWS CLI for Read-Only Testing Verification

## Status

ACCEPTED

## Date

2024-12-09

## Context

The mk8 project creates and manages Kubernetes infrastructure on AWS using Crossplane. During development, especially for integration testing, we need to verify that:

1. **Kubernetes resources** are created correctly (clusters, pods, CRDs, etc.)
2. **AWS resources** are provisioned as expected (EKS clusters, IAM roles, VPCs, etc.)
3. **Crossplane Managed Resources** (MRDs) are reconciled properly

Currently, integration tests rely primarily on:
- `kind` commands for local cluster verification
- mk8's own CLI output
- Limited direct verification of actual resource state

This creates gaps in test coverage where resources may appear correct from mk8's perspective but have issues when inspected directly via Kubernetes API or AWS API.

### The MCP Server vs CLI Tool Question

We evaluated two approaches:
1. **MCP Servers**: Use Kubernetes and AWS MCP servers for structured agent access
2. **CLI Tools**: Use `kubectl` and `aws` CLI directly

**Key Considerations**:
- **Kubernetes MCP servers**: Less mature, limited community support
- **AWS MCP servers**: Available but add abstraction layer
- **Read-only access**: All verification is read-only, no mutations needed
- **Script integration**: Integration tests may use shell scripts (BATS)
- **Ephemeral AWS accounts**: AWS credentials change frequently (4-hour lifetime)
- **Credential management**: Need simple, fast credential rotation

## Decision

We will use **kubectl CLI** and **AWS CLI** directly for read-only verification during integration testing, rather than MCP servers.

**Rationale**:
1. **Maturity**: Both CLIs are official, battle-tested, and comprehensive
2. **Script integration**: Easier to integrate with BATS and shell-based tests
3. **Credential management**: Simpler to handle ephemeral AWS credentials
4. **Read-only scoping**: Easy to configure with RBAC (K8s) and IAM policies (AWS)
5. **No abstraction overhead**: Direct access to APIs without intermediary
6. **Future flexibility**: Can migrate to MCP servers if they mature

**Access Pattern**:
- **kubectl**: Read-only access via kubeconfig generated by mk8 commands
- **AWS CLI**: Read-only access via environment variables or `~/.aws/credentials`

**Credential Strategy**:
- **Kubernetes**: Use kubeconfig from `mk8 bootstrap create` or Crossplane-generated credentials
- **AWS**: Environment variables (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`) for easy rotation
- **GitHub**: Environment variable (`GITHUB_TOKEN`) for long-lived PAT (separate spec)

## Consequences

### Positive

- **Mature tooling**: Official, well-documented, comprehensive coverage
- **Simple integration**: Easy to use in shell scripts and Python tests
- **Fast credential rotation**: Environment variables make AWS credential updates trivial
- **Read-only enforcement**: IAM policies and RBAC provide strong guarantees
- **No additional dependencies**: Tools already required for mk8 development
- **Debugging**: Familiar tools for troubleshooting test failures
- **Comprehensive verification**: Multiple ways to verify correctness increases confidence

### Negative

- **Output parsing**: Need to parse JSON/YAML output from CLI tools
- **Error handling**: Must handle command execution and exit codes
- **Less structured**: Not optimized for agent consumption like MCP
- **Manual credential management**: Requires setting up IAM policies and RBAC

### Neutral

- **Future migration path**: Can adopt MCP servers later if they prove superior
- **Hybrid approach possible**: Could use MCP for some operations, CLI for others

## Alternatives Considered

### Alternative 1: Kubernetes MCP Server

**Description**: Use a Kubernetes MCP server for structured K8s API access.

**Pros:**
- Structured responses optimized for agents
- Built-in error handling
- Potentially simpler read-only scoping

**Cons:**
- **Immature ecosystem**: K8s MCP servers are less established
- Limited community support and documentation
- May not support all kubectl features
- Additional dependency to maintain
- Harder to integrate with shell-based tests

**Why not chosen**: Maturity concerns and script integration challenges outweigh benefits. kubectl is proven and comprehensive.

### Alternative 2: AWS MCP Server

**Description**: Use an AWS MCP server for structured AWS API access.

**Pros:**
- Structured responses for agent consumption
- Built-in pagination and error handling
- Type-safe interactions

**Cons:**
- May not cover all AWS services mk8 needs
- Additional abstraction layer to debug
- Dependency on MCP server maintenance
- Harder to integrate with shell scripts
- Ephemeral credential rotation may be more complex

**Why not chosen**: AWS CLI is comprehensive, well-documented, and easier to integrate with ephemeral credentials. IAM read-only policies are straightforward.

### Alternative 3: Python SDK Libraries (boto3, kubernetes-client)

**Description**: Use Python libraries directly in pytest tests.

**Pros:**
- Native Python integration
- Type hints and IDE support
- No subprocess overhead
- Rich error handling

**Cons:**
- Doesn't help with shell-based tests (BATS)
- More code to write and maintain
- Still need CLI tools for manual debugging
- Credential management similar complexity

**Why not chosen**: While Python SDKs are valuable for some tests, CLI tools provide flexibility for both shell and Python tests, plus manual debugging.

## References

- [kubectl Documentation](https://kubernetes.io/docs/reference/kubectl/)
- [AWS CLI Documentation](https://docs.aws.amazon.com/cli/)
- `.claude/specs/testing-verification-tools/` - Implementation spec
- Related to: ADR-003 (GitHub MCP server)
- Related to: `.claude/specs/prototype/` - Bootstrap testing will use these tools

## Notes

### Read-Only IAM Policy

A sample IAM policy will be created that includes only:
- `Describe*` actions
- `Get*` actions  
- `List*` actions

This policy will be documented with inline comments explaining each permission.

### Read-Only Kubernetes Access

For Kubernetes, read-only access will be achieved via:
- ClusterRole with `get`, `list`, `watch` verbs only
- ServiceAccount bound to the ClusterRole
- Kubeconfig using the ServiceAccount token

### Ephemeral AWS Credentials

For 4-hour ephemeral AWS accounts:
```bash
# Quick credential rotation
export AWS_ACCESS_KEY_ID="AKIA..."
export AWS_SECRET_ACCESS_KEY="..."
export AWS_DEFAULT_REGION="us-west-2"

# Or use helper script (to be created in spec)
./scripts/set-aws-creds.sh
```

### Integration with mk8 Commands

Integration tests will:
1. Run `mk8 bootstrap create` to create cluster
2. Extract kubeconfig path from mk8 output or use standard location
3. Use `kubectl --kubeconfig=<path>` for verification
4. Use `aws` CLI with environment variables for AWS verification

### Future Considerations

- If Kubernetes MCP servers mature, reconsider for agent-driven testing
- If AWS MCP servers prove valuable, evaluate migration path
- Consider Python SDK wrappers for complex verification logic
- May create helper functions/classes to simplify common verification patterns
